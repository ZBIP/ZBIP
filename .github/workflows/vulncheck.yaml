on:
  schedule:
    - cron: 23 12 * * *
permissions:
  contents: read
  issues: write
jobs:
  go-vulncheck:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Run go vulncheck
        uses: golang/govulncheck-action@v1
        with:
           go-version-file: go.mod
           go-package: ./...
      - name: Create Issue on Failure
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_TITLE="Vulnerability Check Failed - $(date +'%Y-%m-%d')"
          ISSUE_BODY="The scheduled vulnerability check has failed. Please investigate the reported issues.\n\nLogs:\n\`\`\`\n${{ steps.vulncheck.outputs.log }}\n\`\`\`"

          EXISTING_ISSUE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues?state=open" | \
            jq -r --arg TITLE "$ISSUE_TITLE" '.[] | select(.title == $TITLE) | .number')

          if [ -z "$EXISTING_ISSUE" ]; then
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/repos/${{ github.repository }}/issues \
              -d "{\"title\":\"$ISSUE_TITLE\",\"body\":\"$ISSUE_BODY\"}"
            echo "New issue created: $ISSUE_TITLE"
          else
            echo "Issue already exists: #$EXISTING_ISSUE"
          fi